{
  "openapi": "3.1.0",
  "servers": [
    {
      "description": "Dev",
      "url": "http://localhost:3000/dev"
    },
    {
      "description": "Sandbox",
      "url": "https://api.sand.gratr.dev"
    },
    {
      "description": "Staging",
      "url": "https://api.stage.gratr.dev"
    },
    {
      "description": "Production",
      "url": "https://api.gratr.dev"
    }
  ],
  "info": {
    "description": "The API driving GRatr, the best tool to rate, review and select GitHub repositories.",
    "version": "0.1.0",
    "title": "GRatr REST API",
    "contact": {
      "email": "troy.forster@gmail.com",
      "name": "Troy Forster",
      "url": "https://www.tforster.com"
    },
    "license": {
      "name": "MIT",
      "url": "https://www.gratr.dev/license"
    }
  },
  "tags": [
    {
      "name": "auth",
      "description": "Authentication and authorisation"
    },
    {
      "name": "rating",
      "description": "Operations related to creating, updating and retrieving repository ratings"
    }
  ],
  "paths": {
    "/auth/tokens": {
      "post": {
        "tags": [
          "auth"
        ],
        "operationId": "tokens",
        "summary": "Sign in with GitHub",
        "description": "Uses GitHub oAuth2 Authorisation Code Grant flow to exchange a GitHub access_token for a GRatr JWT and refresh token.\n",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/tokensPostRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "$ref": "#/components/responses/tokensPost"
          },
          "400": {
            "$ref": "#/components/responses/Error"
          }
        }
      }
    },
    "/auth/refreshtoken": {
      "post": {
        "tags": [
          "auth"
        ],
        "operationId": "refreshtoken",
        "summary": "Refresh token",
        "description": "Refresh token",
        "responses": {
          "204": {
            "$ref": "#/components/responses/CreatedNoContent"
          },
          "400": {
            "$ref": "#/components/responses/Error"
          }
        }
      }
    },
    "/organisations/{organisation}/{repository}": {
      "post": {
        "tags": [
          "rating"
        ],
        "operationId": "createRepositoryRating",
        "summary": "Create a new repository rating record",
        "description": "Creates a new repository rating record ready attributed to the provided user Id. If the user has an existing record for this repository then the operation is converted to an update effectively changing their previous values to the provided values.\n",
        "parameters": [
          {
            "in": "path",
            "name": "organisation",
            "description": "The GitHub organisation name",
            "required": true,
            "schema": {
              "$ref": "#/components/schemas/organisationName"
            }
          },
          {
            "in": "path",
            "name": "repository",
            "description": "The GitHub repository name",
            "required": true,
            "schema": {
              "$ref": "#/components/schemas/repositoryName"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/organisationsOrganisationRepositoryPost"
              }
            }
          }
        },
        "responses": {
          "204": {
            "$ref": "#/components/responses/CreatedNoContent"
          },
          "400": {
            "$ref": "#/components/responses/Error"
          }
        }
      },
      "get": {
        "tags": [
          "rating"
        ],
        "operationId": "readRepositoryRating",
        "summary": "Read all repository ratings",
        "description": "Returns an array of all UGC ratings for this repository\n",
        "parameters": [
          {
            "in": "path",
            "name": "organisation",
            "description": "The GitHub organisation name",
            "required": true,
            "schema": {
              "$ref": "#/components/schemas/organisationName"
            }
          },
          {
            "in": "path",
            "name": "repository",
            "description": "The GitHub repository name",
            "required": true,
            "schema": {
              "$ref": "#/components/schemas/repositoryName"
            }
          }
        ],
        "responses": {
          "200": {
            "$ref": "#/components/responses/readRepositoryRating"
          },
          "400": {
            "$ref": "#/components/responses/Error"
          },
          "404": {
            "$ref": "#/components/responses/NotFound"
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "GitHub": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "gitHubAccessToken": {
        "description": "A token returned from a successful GitHub oAuth2 Authorisation Code Grant flow",
        "type": "string",
        "example": "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"
      },
      "tokensPostRequest": {
        "type": "object",
        "properties": {
          "access_token": {
            "$ref": "#/components/schemas/gitHubAccessToken"
          }
        },
        "additionalProperties": false
      },
      "jwt": {
        "description": "JSON Web Token",
        "type": "object"
      },
      "refreshToken": {
        "description": "A token that can be exchanged for a JWT without logging in a again",
        "type": "string",
        "example": "tbd"
      },
      "organisationName": {
        "description": "The name of the GitHub organisation",
        "type": "string",
        "example": "tforster"
      },
      "repositoryName": {
        "description": "The name of the GitHub repository",
        "type": "string",
        "example": "joy"
      },
      "aggregateName": {
        "type": "string",
        "description": "The name of the aggregate value",
        "example": "Median"
      },
      "aggregateDescription": {
        "type": "string",
        "description": "The description of the aggregate value",
        "example": "The median is defined as the number in the middle of a given set of numbers arranged in order of increasing magnitude."
      },
      "aggregateValue": {
        "type": "number",
        "description": "The aggregate value",
        "example": 2.3
      },
      "aggregateObject": {
        "type": "object",
        "properties": {
          "name": {
            "$ref": "#/components/schemas/aggregateName"
          },
          "description": {
            "$ref": "#/components/schemas/aggregateDescription"
          },
          "value": {
            "$ref": "#/components/schemas/aggregateValue"
          }
        },
        "additionalProperties": false
      },
      "organisationsOrganisationRepositoryPost": {
        "type": "object",
        "properties": {
          "p": {
            "type": "string"
          }
        },
        "additionalProperties": false
      }
    },
    "responses": {
      "tokensPost": {
        "description": "Success. JWT and refreshToken created.",
        "content": {
          "application/json": {
            "schema": {
              "type": "object",
              "properties": {
                "jwt": {
                  "$ref": "#/components/schemas/jwt"
                },
                "refreshToken": {
                  "$ref": "#/components/schemas/refreshToken"
                }
              },
              "additionalProperties": false
            }
          }
        }
      },
      "Error": {
        "description": "Error",
        "content": {
          "application/json": {
            "schema": {
              "type": "object",
              "properties": {
                "message": {
                  "type": "string"
                },
                "details": {
                  "type": "string"
                }
              },
              "additionalProperties": false
            }
          }
        }
      },
      "CreatedNoContent": {
        "description": "Created. No content."
      },
      "readRepositoryRating": {
        "description": "Success. Ratings returned.",
        "content": {
          "application/json": {
            "schema": {
              "type": "object",
              "properties": {
                "organisationName": {
                  "$ref": "#/components/schemas/organisationName"
                },
                "repositoryName": {
                  "$ref": "#/components/schemas/repositoryName"
                },
                "aggregates": {
                  "$ref": "#/components/schemas/aggregateObject"
                },
                "ratings": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "username": {
                        "type": "string"
                      }
                    },
                    "additionalProperties": {
                      "$ref": "#/components/schemas/organisationName"
                    }
                  }
                }
              },
              "additionalProperties": false
            }
          }
        }
      },
      "NotFound": {
        "description": "Resource was not found",
        "content": {
          "application/json": {
            "schema": {
              "type": "object",
              "properties": {
                "resourceNotFound": {
                  "type": "string"
                }
              },
              "additionalProperties": false
            }
          }
        }
      }
    }
  }
}